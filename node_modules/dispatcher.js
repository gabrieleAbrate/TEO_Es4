const fs = require('fs');
const url = require('url');

// dispatcher => smistatore di azioni
class dispatcher{
    // elenco delle funzioni che il server può eseguire
    // il vettore associativo è un oggetto
    #servizi = {};

    // header di default
    #header = {};

    // estensione del file
    #estensioni = {
        'html': 'text/html',
        'css': 'text/css',
        'js': 'text/javascript',
        'png': 'image/png',
        'jpg': 'image/jpg',
        'jpeg': 'image/jpeg',
        'gif': 'image/gif',
        'json': 'application/json'
    };

    constructor(header){
        this.#header = header;
    }

    addServizio(nomeServizio, servizio){ this.#servizi[nomeServizio] = servizio; }

    // risorsa statica => indica un file statico come ad esempio un file html, css, js, ecc...
    // risorsa dinamica => indica un file che viene generato dinamicamente dal server (servizio)
    smista(richiesta, risposta){
        let risorsa = url.parse(richiesta.headers.host + richiesta.url, true).pathname;
        let stato = true;
        let funzione = this.#servizi[risorsa];

        if(funzione)
            funzione(richiesta, risposta);
        else if(risorsa.includes('.') || risorsa == '/')
            this.ritornaRisorsaStatica(risorsa, richiesta, risposta);
        else
            stato = false;

        return stato;
    }

    ritornaRisorsaStatica(risorsa, richiesta, risposta){
        if(risorsa == '/')
            risorsa = '/index.html';

        try{
            let file = fs.readFileSync('public' + risorsa);
                        
            this.#header['Content-Type'] = this.#estensioni[risorsa.split('.')[1]];

            risposta.writeHead(200, this.#header);
            risposta.write(file);
            risposta.end();
        }
        catch(ex){
            this.#header['Content-Type'] = 'text/plain';
            risposta.writeHeader(404, this.#header);
            risposta.write('404 - pagina non trovata');
            risposta.end();
        }
    }
}

module.exports = dispatcher;